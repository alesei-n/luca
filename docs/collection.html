<!DOCTYPE html>  <html> <head>   <title>collection.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="base_toolbar.html">                 base_toolbar.coffee               </a>                                           <a class="source" href="button_field.html">                 button_field.coffee               </a>                                           <a class="source" href="checkbox_field.html">                 checkbox_field.coffee               </a>                                           <a class="source" href="file_upload_field.html">                 file_upload_field.coffee               </a>                                           <a class="source" href="hidden_field.html">                 hidden_field.coffee               </a>                                           <a class="source" href="select_field.html">                 select_field.coffee               </a>                                           <a class="source" href="text_area_field.html">                 text_area_field.coffee               </a>                                           <a class="source" href="text_field.html">                 text_field.coffee               </a>                                           <a class="source" href="type_ahead_field.html">                 type_ahead_field.coffee               </a>                                           <a class="source" href="filterable_collection.html">                 filterable_collection.coffee               </a>                                           <a class="source" href="form_button_toolbar.html">                 form_button_toolbar.coffee               </a>                                           <a class="source" href="form_view.html">                 form_view.coffee               </a>                                           <a class="source" href="grid_view.html">                 grid_view.coffee               </a>                                           <a class="source" href="bread_crumb_navigatiion.html">                 bread_crumb_navigatiion.coffee               </a>                                           <a class="source" href="template.html">                 template.coffee               </a>                                           <a class="source" href="card_view.html">                 card_view.coffee               </a>                                           <a class="source" href="column_view.html">                 column_view.coffee               </a>                                           <a class="source" href="modal_view.html">                 modal_view.coffee               </a>                                           <a class="source" href="panel_view.html">                 panel_view.coffee               </a>                                           <a class="source" href="split_view.html">                 split_view.coffee               </a>                                           <a class="source" href="tab_view.html">                 tab_view.coffee               </a>                                           <a class="source" href="viewport.html">                 viewport.coffee               </a>                                           <a class="source" href="collection.html">                 collection.coffee               </a>                                           <a class="source" href="container.html">                 container.coffee               </a>                                           <a class="source" href="field.html">                 field.coffee               </a>                                           <a class="source" href="view.html">                 view.coffee               </a>                                           <a class="source" href="framework.html">                 framework.coffee               </a>                                           <a class="source" href="collection_manager.html">                 collection_manager.coffee               </a>                                           <a class="source" href="socket_manager.html">                 socket_manager.coffee               </a>                                           <a class="source" href="deferrable.html">                 deferrable.coffee               </a>                                           <a class="source" href="local_storage.html">                 local_storage.coffee               </a>                                           <a class="source" href="spin.html">                 spin.coffee               </a>                                           <a class="source" href="toolbars.html">                 toolbars.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               collection.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Luca.Collection</p>

<p>Luca.Collection is an extenstion of Backbone.Collection which provides
a bunch of commonly used patterns for doing things like:</p>

<ul>
<li><p>setting base parameters used on every request to your REST API</p></li>
<li><p>bootstrapping a collection of objects which are 
rendered in your markup on page load</p></li>
<li><p>filtering with query string parameters against your API</p></li>
<li><p>automatic interaction with your Luca.CollectionManager class</p></li>
<li><p>make it easier to parse Rails style responses which include the root
by specifying a @root parameter</p></li>
<li><p>use backbone-query if available</p></li>
<li><p>onceLoaded: run a callback once if there are models present, otherwise wait until
the collection fetches</p></li>
<li><p>ifLoaded: run a callback any time the model gets reset, or if there are already models</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Luca.Collection = </span><span class="p">(</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">QueryCollection</span> <span class="o">||</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">).</span><span class="nx">extend</span>
  
  <span class="nv">initialize: </span><span class="nf">(models, @options={})-&gt;</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="err">@</span><span class="p">,</span> <span class="nx">@options</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>By specifying a @cached property or method, you can instruct
Luca.Collection instances where to pull an array of model attributes
usually done with the bootstrap functionality provided.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@cached</span>
      <span class="vi">@bootstrap_cache_key = </span><span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">@cached</span> <span class="p">)</span> <span class="k">then</span> <span class="nx">@cached</span><span class="p">()</span> <span class="k">else</span> <span class="nx">@cached</span>  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>If we are going to be registering this collection with the CollectionManager
class, then we need to specify a key to register ourselves under. @registerAs can be 
as simple as something as "books", or if you are using collections which need
to be scoped with some sort of unique id, as say some sort of belongsTo relationship
then you can specify @registerAs as a method()</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@registerWith</span>
      <span class="nx">@registerAs</span> <span class="o">||=</span> <span class="nx">@cached</span>
      <span class="vi">@registerAs = </span><span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">@registerAs</span> <span class="p">)</span> <span class="k">then</span> <span class="nx">@registerAs</span><span class="p">()</span> <span class="k">else</span> <span class="nx">@registerAs</span>

      <span class="nx">@bind</span> <span class="s2">&quot;after:initialize&quot;</span><span class="p">,</span> <span class="p">()</span><span class="o">=&gt;</span>
        <span class="nx">@register</span><span class="p">(</span> <span class="nx">@registerWith</span><span class="p">,</span> <span class="nx">@registerAs</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Populating a collection with local data</p>

<p>by specifying a @data property which is an array
then you can set the collection to be a @memoryCollection
which never interacts with a persistence layer at all.</p>

<p>this is mainly used by the Luca.fields.SelectField class for
generating simple select fields with static data  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">@data</span><span class="p">)</span> <span class="o">and</span> <span class="nx">@data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="vi">@memoryCollection = </span><span class="kc">true</span>
    
    <span class="nx">@__wrapUrl</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">@useNormalUrl</span> <span class="o">is</span> <span class="kc">true</span>
     
    <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="p">[</span><span class="nx">models</span><span class="p">,</span> <span class="nx">@options</span><span class="p">]</span> 

    <span class="nx">@trigger</span> <span class="s2">&quot;after:initialize&quot;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h3>Automatic Query String Generation</h3>

<p>Luca.Collections will append a query string to the URL 
and will automatically do this for you without you having
to write a special url handler.  If you want to use a normal
url without this feature, just set @useNormalUrl = true</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">__wrapUrl: </span><span class="nf">()-&gt;</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">@url</span><span class="p">)</span>
      <span class="vi">@url = </span><span class="nx">_</span><span class="p">.</span><span class="nx">wrap</span> <span class="nx">@url</span><span class="p">,</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span><span class="o">=&gt;</span>
        <span class="nv">val = </span><span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span> 
        <span class="nv">parts = </span><span class="nx">val</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>

        <span class="nv">existing_params = </span><span class="nx">_</span><span class="p">.</span><span class="nx">last</span><span class="p">(</span><span class="nx">parts</span><span class="p">)</span> <span class="k">if</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="nv">queryString = </span><span class="nx">@queryString</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="nx">existing_params</span> <span class="o">and</span> <span class="nx">val</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">existing_params</span><span class="p">)</span>
          <span class="nv">queryString = </span><span class="nx">queryString</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">existing_params</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="nv">new_val = </span><span class="s2">&quot;#{ val }?#{ queryString }&quot;</span>
        <span class="nv">new_val = </span><span class="nx">new_val</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\?$/</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">new_val</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\?$/</span><span class="p">)</span>

        <span class="nx">new_val</span>
    <span class="k">else</span>
      <span class="nv">url = </span><span class="nx">@url</span>
      <span class="nv">params = </span><span class="nx">@queryString</span><span class="p">()</span>
      
      <span class="vi">@url = </span><span class="nx">_</span><span class="p">([</span><span class="nx">url</span><span class="p">,</span><span class="nx">params</span><span class="p">]).</span><span class="nx">compact</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>  

  <span class="nv">queryString: </span><span class="nf">()-&gt;</span>
    <span class="nv">parts = </span><span class="nx">_</span><span class="p">(</span> <span class="nx">@base_params</span> <span class="o">||=</span> <span class="nx">Luca</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">baseParams</span><span class="p">()</span> <span class="p">).</span><span class="nx">inject</span> <span class="p">(</span><span class="nx">memo</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span><span class="o">=&gt;</span>
      <span class="nv">str = </span><span class="s2">&quot;#{ key }=#{ value }&quot;</span>
      <span class="nx">memo</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
      <span class="nx">memo</span>
    <span class="p">,</span> <span class="p">[]</span> 

    <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">parts</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">)</span>

  <span class="nv">resetFilter: </span><span class="nf">()-&gt;</span>
    <span class="vi">@base_params = </span><span class="nx">Luca</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">baseParams</span><span class="p">()</span>
    <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Applying a filter to a collection, will automatically apply
the filter parameters and then call fetch.  passing an additional
options hash will pass these options to the call to @fetch()
setting refresh to true, forcing a remote call to the REST API</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">applyFilter: </span><span class="nf">(filter={}, options={})-&gt;</span>
    <span class="nx">@applyParams</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span>
    <span class="nx">@fetch</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span><span class="nx">refresh</span><span class="o">:</span><span class="kc">true</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>You can apply params to a collection, so that any upcoming requests
made to the REST API are made with the key values specified </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">applyParams: </span><span class="nf">(params)-&gt;</span>
    <span class="nx">@base_params</span> <span class="o">||=</span> <span class="nx">Luca</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">baseParams</span><span class="p">()</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">@base_params</span><span class="p">,</span> <span class="nx">params</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Collection Manager Registry</p>

<p>If this collection is to be registered with some global collection
tracker such as new Luca.CollectionManager() then we will register 
ourselves automatically</p>

<p>To automatically register a collection with the registry, instantiate
it with the registerWith property, which can either be a reference to
the manager itself, or a string in case the manager isn't available
at compile time</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">register: </span><span class="nf">(collectionManager=&quot;&quot;, key=&quot;&quot;, collection)-&gt;</span>
    
    <span class="k">throw</span> <span class="s2">&quot;Can not register with a collection manager without a key&quot;</span> <span class="nx">unless</span> <span class="nx">key</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">throw</span> <span class="s2">&quot;Can not register with a collection manager without a valid collection manager&quot;</span> <span class="nx">unless</span> <span class="nx">collectionManager</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span> <span class="nx">collectionManager</span> <span class="p">)</span>
      <span class="nv">collectionManager = </span><span class="nx">Luca</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">nestedValue</span><span class="p">(</span> <span class="nx">collectionManager</span><span class="p">,</span> <span class="nb">window</span> <span class="p">)</span>
      
    <span class="k">throw</span> <span class="s2">&quot;Could not register with collection manager&quot;</span> <span class="nx">unless</span> <span class="nx">collectionManager</span> 
    
    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">collectionManager</span><span class="p">.</span><span class="nx">add</span> <span class="p">)</span>
      <span class="k">return</span> <span class="nx">collectionManager</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">collection</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span> <span class="nx">collect</span><span class="p">)</span>
      <span class="nx">collectionManager</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">collection</span>
  </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>A Luca.Collection will load models from the in memory model store
returned from Luca.Collection.cache, where the key returned from 
the @cached attribute or method matches the key of the model cache  </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">loadFromBootstrap: </span><span class="nf">()-&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@bootstrap_cache_key</span>
    <span class="nx">@reset</span> <span class="nx">@cached_models</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>an alias for loadFromBootstrap which is a bit more descriptive</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bootstrap: </span><span class="nf">()-&gt;</span> <span class="nx">@loadFromBootstrap</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>cached<em>models is a reference to the Luca.Collection.cache object
key'd on whatever this collection's bootstrap</em>cache_key is set to be
via the @cached() interface</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cached_models: </span><span class="nf">()-&gt;</span>
    <span class="nx">Luca</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span> <span class="nx">@bootstrap_cache_key</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Luca.Collection overrides the default Backbone.Collection.fetch method
and triggers an event "before:fetch" which gives you additional control
over the process</p>

<p>in addition, it loads models directly from the bootstrap cache instead
of going directly to the API </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fetch: </span><span class="nf">(options={})-&gt;</span>
    <span class="nx">@trigger</span> <span class="s2">&quot;before:fetch&quot;</span><span class="p">,</span> <span class="err">@</span>

    <span class="k">return</span> <span class="nx">@reset</span><span class="p">(</span><span class="nx">@data</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@memoryCollection</span> <span class="o">is</span> <span class="kc">true</span>
    </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>fetch will try to pull from the bootstrap if it is setup to do so
you can actually make the roundtrip to the server anyway if you pass
refresh = true in the options hash </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">@bootstrap</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@cached_models</span><span class="p">().</span><span class="nx">length</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">refresh</span>
    

    <span class="nv">url = </span><span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">@url</span><span class="p">)</span> <span class="k">then</span> <span class="nx">@url</span><span class="p">()</span> <span class="k">else</span> <span class="nx">@url</span>
    
    <span class="k">return</span> <span class="kc">true</span> <span class="nx">unless</span> <span class="p">((</span><span class="nx">url</span> <span class="o">and</span> <span class="nx">url</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@localStorage</span><span class="p">)</span>

    <span class="vi">@fetching = </span><span class="kc">true</span>

    <span class="k">try</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fetch</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="k">catch</span> <span class="nx">e</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Error in Collection.fetch&quot;</span><span class="p">,</span> <span class="nx">e</span>
      
      <span class="k">throw</span> <span class="nx">e</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>onceLoaded is equivalent to binding to the 
reset trigger with a function wrapped in _.once 
so that it only gets run...ahem...once.</p>

<p>that being said, if the collection already has models
it won't even bother fetching it it will just run
as if reset was already triggered </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">onceLoaded: </span><span class="nf">(fn)-&gt;</span>
    <span class="k">if</span> <span class="nx">@length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@fetching</span>
      <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="p">[</span><span class="err">@</span><span class="p">]</span>
      <span class="k">return</span>
    
    <span class="nv">wrapped = </span><span class="p">()</span><span class="o">=&gt;</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,[</span><span class="err">@</span><span class="p">]</span>

    <span class="nx">@bind</span> <span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="p">()</span><span class="o">=&gt;</span>
      <span class="nx">wrapped</span><span class="p">()</span>
      <span class="nx">@unbind</span> <span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="nx">wrapped</span>
  </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>ifLoaded is equivalent to binding to the reset trigger with
a function, if the collection already has models it will just
run automatically.  similar to onceLoaded except the binding
stays in place </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ifLoaded: </span><span class="nf">(fn, scope=@)-&gt;</span>
    <span class="k">if</span> <span class="nx">@models</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@fetching</span>
      <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">scope</span><span class="p">,</span> <span class="p">[</span><span class="err">@</span><span class="p">]</span>
      <span class="k">return</span>

    <span class="nx">@bind</span> <span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">collection</span><span class="p">)</span><span class="o">=&gt;</span>
      <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">scope</span><span class="p">,</span> <span class="p">[</span><span class="nx">collection</span><span class="p">]</span>

    <span class="nx">unless</span> <span class="nx">@fetching</span>
      <span class="nx">@fetch</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>parse is very close to the stock Backbone.Collection parse, which
just returns the response.  However, it also triggers a callback
after:response, and automatically parses responses which contain
a JSON root like you would see in rails, if you specify the @root
property.</p>

<p>it will also update the Luca.Collection.cache with the models from
the response, so that any subsequent calls to fetch() on a bootstrapped
collection, will have updated models from the server.  Really only
useful if you call fetch(refresh:true) manually on any bootstrapped
collection</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">parse: </span><span class="nf">(response)-&gt;</span> 
    <span class="vi">@fetching = </span><span class="kc">false</span>
    <span class="nx">@trigger</span> <span class="s2">&quot;after:response&quot;</span>
    <span class="nv">models = </span><span class="k">if</span> <span class="nx">@root</span><span class="o">?</span> <span class="k">then</span> <span class="nx">response</span><span class="p">[</span> <span class="nx">@root</span> <span class="p">]</span> <span class="k">else</span> <span class="nx">response</span>
    
    <span class="k">if</span> <span class="nx">@bootstrap_cache_key</span>
      <span class="nx">Luca</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span> <span class="nx">@bootstrap_cache_keys</span><span class="p">,</span> <span class="nx">models</span><span class="p">)</span>

    <span class="nx">models</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h3>Base Parameters</h3>

<p>Always include these parameters in every request to your REST API.</p>

<p>either specify a function which returns a hash, or just a normal hash </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Luca.Collection.baseParams = </span><span class="nf">(obj)-&gt;</span>
  <span class="k">return</span> <span class="nv">Luca.Collection._baseParams = </span><span class="nx">obj</span> <span class="k">if</span> <span class="nx">obj</span>

  <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">Luca</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">_baseParams</span> <span class="p">)</span>
    <span class="k">return</span> <span class="nx">Luca</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">_baseParams</span><span class="p">.</span><span class="nx">call</span><span class="p">()</span>
  
  <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span> <span class="nx">Luca</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">_baseParams</span> <span class="p">)</span>
    <span class="nx">Luca</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">_baseParams</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h3>Bootstrapped Models ( stuff loaded on page load )</h3>

<p>In order to make our Backbone Apps super fast it is a good practice
to pre-populate your collections by what is referred to as bootstrapping</p>

<p>Luca.Collections make it easier for you to do this cleanly and automatically</p>

<p>by specifying a @cached property or method in your collection definition
Luca.Collections will automatically look in this space to find models
and avoid a roundtrip to your API unless explicitly told to.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Luca.Collection._bootstrapped_models = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>In order to do this, just load an object whose keys</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Luca.Collection.bootstrap = </span><span class="nf">(obj)-&gt;</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">Luca</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">_bootstrapped_models</span><span class="p">,</span> <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Lookup cached() or bootstrappable models.  This is used by the
augmented version of Backbone.Collection.fetch() in order to avoid
roundtrips to the API</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Luca.Collection.cache = </span><span class="nf">(key, models)-&gt;</span>
  <span class="k">return</span> <span class="nx">Luca</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">_bootstrapped_models</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">models</span> <span class="k">if</span> <span class="nx">models</span>
  <span class="nx">Luca</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">_bootstrapped_models</span><span class="p">[</span> <span class="nx">key</span> <span class="p">]</span> <span class="o">||</span> <span class="p">[]</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 